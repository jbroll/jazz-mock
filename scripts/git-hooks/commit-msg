#!/bin/bash
set -euo pipefail

COMMIT_MSG_FILE="$1"
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# Skip merge commits, reverts, etc.
if grep -qE "^(Merge|Revert)" "$COMMIT_MSG_FILE"; then
    exit 0
fi

# Check if this commit only contains documentation/non-code files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

CODE_FILE_PATTERNS="\.tsx?$|\.jsx?$|\.css$|\.json$|\.html$|package\.json|tsconfig\.json"

if ! echo "$STAGED_FILES" | grep -qE "$CODE_FILE_PATTERNS"; then
    echo "ðŸ“ Documentation-only commit detected - skipping test suite"
    echo "âœ… Commit message validation passed"
    exit 0
fi

# Get project root (where package.json is)
PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
cd "$PROJECT_ROOT"

# Setup logging
LOG_DIR="$PROJECT_ROOT/.git/hooks/logs"
mkdir -p "$LOG_DIR"
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
LOG_FILE="$LOG_DIR/pre-commit-$TIMESTAMP.log"

log_only() {
    cat >> "$LOG_FILE"
}

log_and_display() {
    tee -a "$LOG_FILE"
}

{
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "  Pre-Commit Validation Log"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "Started: $(date)"
    echo "Project: $PROJECT_ROOT"
    echo "Log file: $LOG_FILE"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
} | log_only

echo "Running pre-commit validation..."
echo "Log: $LOG_FILE"
echo ""

section() {
    {
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "  $1"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
    } | log_only
    echo -n "  $1... "
}

fail() {
    echo "FAILED"
    echo ""
    echo "FAILED: $1"
    echo "See log for details: $LOG_FILE"
    echo ""
    {
        echo ""
        echo "Pre-commit validation FAILED: $1"
        echo ""
    } >> "$LOG_FILE"
    exit 1
}

# 1. TypeScript Type Checking
section "1/3: TypeScript Type Checking"
if ! npm run typecheck 2>&1 | log_only; then
    fail "TypeScript type checking failed"
fi
echo "OK"
echo "TypeScript type checking passed" >> "$LOG_FILE"

# 2. Biome Linting
section "2/3: Biome Linting"
if ! npm run lint 2>&1 | log_only; then
    fail "Biome linting failed"
fi
echo "OK"
echo "Biome linting passed" >> "$LOG_FILE"

# 3. Unit Tests (Vitest)
section "3/3: Unit Tests (Vitest)"
if ! npm test 2>&1 | log_only; then
    fail "Unit tests failed"
fi
echo "OK"
echo "Unit tests passed" >> "$LOG_FILE"

# All checks passed
{
    echo ""
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "  ALL PRE-COMMIT CHECKS PASSED"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    echo "Completed: $(date)"
    echo "Duration: $SECONDS seconds"
    echo ""
} >> "$LOG_FILE"

echo ""
echo "All checks passed (${SECONDS}s)"
echo ""

exit 0
